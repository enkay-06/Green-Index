<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="search.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - Green Index</title>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" style="font-size: 1.5rem; font-weight: bold; color: white; text-decoration: none;"> Green Index</a>
        <div class="nav-right">
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="search.html">Search</a>
                <a href="overview.html">Overview</a>
                <a href="rScore.html">Calculator</a>
            </div>
            <div class="nav-search">
                <input type="text" id="search-input" placeholder="Search materials...">
                <button id="search-btn">Search</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <aside class="filter-sidebar">
            <h3>Filters</h3>
            
            <div class="filter-section">
                <h4>Material Types</h4>
                
                <div class="filter-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="metal-filter" class="material-checkbox">
                        Metal
                    </label>
                    <div id="metal-options" class="sub-options" style="display: none;">
                        <label>Magnetism</label>
                        <select id="magnetism-select">
                            <option value="any">Any</option>
                            <option value="Ferrous">Ferrous</option>
                            <option value="Non-ferrous">Non-ferrous</option>
                        </select>
                        <label>Melting Point Range (°C)</label>
                        <input type="range" id="metal-melting-point" min="200" max="3500" value="1000">
                        <span id="metal-melting-value">1000°C</span>
                        <label>Thermal Stability</label>
                        <select id="metal-thermal">
                            <option value="any">Any</option>
                            <option value="Low">Low</option>
                            <option value="Moderate">Moderate</option>
                            <option value="High">High</option>
                            <option value="Very High">Very High</option>
                        </select>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="polymer-filter" class="material-checkbox">
                        Polymer
                    </label>
                    <div id="polymer-options" class="sub-options" style="display: none;">
                        <label>Polymer Type</label>
                        <select id="polymer-type">
                            <option value="any">Any</option>
                            <option value="PET">PET</option>
                            <option value="HDPE">HDPE</option>
                            <option value="LDPE">LDPE</option>
                            <option value="PP">PP</option>
                            <option value="PS">PS</option>
                            <option value="PVC">PVC</option>
                            <option value="PMMA">PMMA</option>
                            <option value="PC">PC</option>
                            <option value="PTFE">PTFE</option>
                            <option value="Other">Other</option>
                        </select>
                        <label>Additives</label>
                        <select id="additives">
                            <option value="any">Any</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <label>Density Range (g/cm³)</label>
                        <input type="range" id="density" min="0.05" max="2.5" step="0.1" value="1.0">
                        <span id="density-value">1.0 g/cm³</span>
                        <label>Toxicity</label>
                        <select id="polymer-toxicity">
                            <option value="any">Any</option>
                            <option value="Low">Low</option>
                            <option value="Moderate">Moderate</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="glass-filter" class="material-checkbox">
                        Glass
                    </label>
                    <div id="glass-options" class="sub-options" style="display: none;">
                        <label>Melting Point Range (°C)</label>
                        <input type="range" id="glass-melting-point" min="500" max="2000" value="800">
                        <span id="glass-melting-value">800°C</span>
                        <label>Density Range (g/cm³)</label>
                        <input type="range" id="glass-density" min="2.0" max="3.5" step="0.1" value="2.5">
                        <span id="glass-density-value">2.5 g/cm³</span>
                        <label>Toxicity</label>
                        <select id="glass-toxicity">
                            <option value="any">Any</option>
                            <option value="Low">Low</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ceramic-filter" class="material-checkbox">
                        Ceramic
                    </label>
                    <div id="ceramic-options" class="sub-options" style="display: none;">
                        <label>Melting Point Range (°C)</label>
                        <input type="range" id="ceramic-melting-point" min="1500" max="4000" value="2500">
                        <span id="ceramic-melting-value">2500°C</span>
                        <label>Thermal Stability</label>
                        <select id="ceramic-thermal">
                            <option value="any">Any</option>
                            <option value="Moderate">Moderate</option>
                            <option value="High">High</option>
                            <option value="Very High">Very High</option>
                        </select>
                        <label>Density Range (g/cm³)</label>
                        <input type="range" id="ceramic-density" min="1.5" max="6.5" step="0.1" value="3.0">
                        <span id="ceramic-density-value">3.0 g/cm³</span>
                    </div>
                </div>
            </div>

            <button id="apply-filters">Apply Filters</button>
            <button id="clear-filters">Clear All</button>
        </aside>

        <main class="results-section">
            <div class="results-header">
                <h2>Search Results</h2>
                <span id="results-count">12 materials found</span>
            </div>

            <div class="results-grid" id="results-container">
                <!-- Results will be loaded from CSV data -->
            </div>
        </main>
    </div>

    <script>
        let materialsData = [];
        let filteredMaterials = [];

        async function loadMaterialsData() {
            try {
                const response = await fetch('materialsData.csv');
                const csvText = await response.text();
                materialsData = parseCSV(csvText);
                filteredMaterials = [...materialsData];
                displayMaterials(filteredMaterials);
                updateResultsCount(filteredMaterials.length);
            } catch (error) {
                console.error('Error loading materials data:', error);
                document.getElementById('results-container').innerHTML = 
                    '<p style="text-align: center; color: #666;">Error loading materials data. Please refresh the page.</p>';
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const materials = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const material = {};
                
                headers.forEach((header, index) => {
                    material[header.trim()] = values[index] ? values[index].trim() : '';
                });
                
                materials.push(material);
            }
            
            return materials;
        }
        function calculateRecyclabilityScore(material) {
            let score = 0;

            // Category scoring (0–3)
            const categoryScores = {
                'Metal': 3.0,
                'Glass': 2.5,
                'Polymer': 2.0,
                'Ceramic': 1.0,
                'Composite': 0.5
            };
            score += categoryScores[material.Category] || 0;

            // Thermal Stability (0–2), slightly adjusted for recyclability logic
            const thermalScores = {
                'Low': 0.5,
                'Moderate': 1.5,
                'High': 1.0,
                'Very High': 0.5
            };
            score += thermalScores[material['Thermal Stability']] || 0;

            // Magnetism (0–1)
            const magneticScore = (material.Category === 'Metal' && material.Magnetism === 'Ferrous') ? 1.0 : 0.0;
            score += magneticScore;

            // Melting Point (0–1.5), material-specific
            const meltingPoint = material['Melting Point']; // °C
            if (material.Category === 'Polymer') {
                if (meltingPoint < 200) {
                    score += 1.5;
                } else if (meltingPoint < 350) {
                    score += 1.0;
                } else {
                    score += 0.5;
                }
            } else if (material.Category === 'Metal') {
                if (meltingPoint < 800) {
                    score += 0.5; // Too soft, not common
                } else if (meltingPoint < 1500) {
                    score += 1.5;
                } else {
                    score += 1.0;
                }
            } else if (material.Category === 'Glass' || material.Category === 'Ceramic') {
                if (meltingPoint < 1000) {
                    score += 1.5;
                } else if (meltingPoint < 1600) {
                    score += 1.0;
                } else {
                    score += 0.5;
                }
            }

            // Density (0–1), general heuristic
            const density = material.Density;
            if (density < 1.0) {
                score += 1.0;
            } else if (density < 3.0) {
                score += 0.5;
            }

            // Toxicity (0–2), inverse score
            const toxicityScores = {
                'Low': 2.0,
                'Moderate': 1.0,
                'High': 0.3,
                'Very High': 0.0
            };
            score += toxicityScores[material.Toxicity] || 0;

            // Polymer Type (0–1.5) – only if polymer
            const polymerTypeScores = {
                'PET': 1.5,
                'HDPE': 1.5,
                'PP': 1.0,
                'PVC': 0.5,
                'PS': 0.5,
                'Other': 0.0
            };
            if (material.Category === 'Polymer') {
                score += polymerTypeScores[material['Polymer Type']] || 0;
            }

            // Additives (penalty of up to -1)
            if (material.Category === 'Polymer' && material.Additives === 'Yes') {
                score -= 1.0;
            }
            let demandScore = 0.5;

            if (material.Category === 'Metal') {
                demandScore = material.Magnetism === 'Ferrous' ? 1.0 : 0.8; // Slightly less for non-ferrous
            } else if (material.Category === 'Glass') {
                demandScore = 1.0;
            } else if (material.Category === 'Polymer') {
                demandScore = ['PET', 'HDPE'].includes(material['Polymer Type']) ? 1.0 : 0.5;
            } else if (material.Category === 'Ceramic') {
                demandScore = 0.3;
            } else if (material.Category === 'Composite') {
                demandScore = 0.2;
            }

            score += demandScore;

            return Math.min(Math.max(Math.round(score * 100) / 100, 0), 10);      
        }


        function getRecyclabilityRating(score) {
            if (score >= 8) return 'Excellent';
            if (score >= 6) return 'Good';
            if (score >= 4) return 'Moderate';
            return 'Poor';
        }

        // Display materials in the grid
        function displayMaterials(materials) {
            const container = document.getElementById('results-container');
            
            if (materials.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">No materials found matching your criteria.</p>';
                return;
            }

            container.innerHTML = materials.map(material => {
                const materialId = material.Material.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const categoryClass = material.Category.toLowerCase();
                const recyclabilityScore = calculateRecyclabilityScore(material);
                const recyclabilityRating = getRecyclabilityRating(recyclabilityScore);
                
                // Create property details based on category
                let details = [];
                
                if (material.Category === 'Metal') {
                    if (material.Magnetism) details.push(`Magnetism: ${material.Magnetism}`);
                    if (material['Melting Point']) details.push(`Melting Point: ${material['Melting Point']}°C`);
                    if (material['Thermal Stability']) details.push(`Thermal Stability: ${material['Thermal Stability']}`);
                } else if (material.Category === 'Polymer') {
                    if (material['Polymer Type']) details.push(`Polymer: ${material['Polymer Type']}`);
                    if (material['Melting Point']) details.push(`Melting Point: ${material['Melting Point']}°C`);
                    if (material.Additives) details.push(`Additives: ${material.Additives}`);
                } else if (material.Category === 'Glass') {
                    if (material['Melting Point']) details.push(`Melting Point: ${material['Melting Point']}°C`);
                } else if (material.Category === 'Ceramic') {
                    if (material['Melting Point']) details.push(`Melting Point: ${material['Melting Point']}°C`);
                    if (material['Thermal Stability']) details.push(`Thermal Stability: ${material['Thermal Stability']}`);
                } else if (material.Category === 'Composite') {
                    if (material['Melting Point']) details.push(`Melting Point: ${material['Melting Point']}°C`);
                }
                
                // Common properties
                if (material.Density) details.push(`Density: ${material.Density} g/cm³`);
                if (material.Toxicity) details.push(`Toxicity: ${material.Toxicity}`);
                
                details.push(`Recyclability Score: ${recyclabilityScore}/10 (${recyclabilityRating})`);

                return `
                    <div class="result-card ${categoryClass}-material" onclick="openMaterialDetails('${materialId}', '${material.Material}')">
                        <h3>${material.Material}</h3>
                        <p class="material-type">${material.Category}</p>
                        <div class="material-details">
                            ${details.map(detail => `<span>${detail}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update results count
        function updateResultsCount(count) {
            document.getElementById('results-count').textContent = `${count} materials found`;
        }

        // Filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load materials data when page loads
            loadMaterialsData();

            const materialCheckboxes = document.querySelectorAll('.material-checkbox');
            const sliders = document.querySelectorAll('input[type="range"]');
            
            // Handle material checkbox changes - only show/hide options, don't filter
            materialCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const materialType = this.id.replace('-filter', '');
                    const options = document.getElementById(materialType + '-options');
                    options.style.display = this.checked ? 'block' : 'none';
                });
            });

            // Handle slider value updates - only update display values, don't filter
            sliders.forEach(slider => {
                slider.addEventListener('input', function() {
                    const valueSpan = document.getElementById(this.id + '-value');
                    if (valueSpan) {
                        let unit = this.id.includes('density') ? ' g/cm³' : '°C';
                        valueSpan.textContent = this.value + unit;
                    }
                });
            });

            // Search functionality - only update on manual search, not automatic
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            function performSearch() {
                // Only perform search if apply filters is clicked or search button is clicked
                // Don't auto-filter on input
            }

            searchBtn.addEventListener('click', applyFilters);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') applyFilters();
            });

            // Apply filters button - this is the only way to actually filter
            document.getElementById('apply-filters').addEventListener('click', applyFilters);

            // Clear filters
            document.getElementById('clear-filters').addEventListener('click', function() {
                // Reset all checkboxes
                materialCheckboxes.forEach(cb => {
                    cb.checked = false;
                    const materialType = cb.id.replace('-filter', '');
                    const options = document.getElementById(materialType + '-options');
                    options.style.display = 'none';
                });
                
                // Reset all sliders to their default values
                sliders.forEach(slider => {
                    if (slider.id === 'metal-melting-point') slider.value = 1000;
                    else if (slider.id === 'density') slider.value = 1.0;
                    else if (slider.id === 'glass-melting-point') slider.value = 800;
                    else if (slider.id === 'glass-density') slider.value = 2.5;
                    else if (slider.id === 'ceramic-melting-point') slider.value = 2500;
                    else if (slider.id === 'ceramic-density') slider.value = 3.0;
                    else slider.value = slider.getAttribute('value') || slider.min;
                    
                    slider.dispatchEvent(new Event('input'));
                });
                
                // Reset all selects
                document.querySelectorAll('select').forEach(select => {
                    select.selectedIndex = 0;
                });
                
                // Reset search input
                searchInput.value = '';
                
                // Show all materials
                filteredMaterials = [...materialsData];
                displayMaterials(filteredMaterials);
                updateResultsCount(filteredMaterials.length);
            });
        });

        // Apply all active filters
        function applyFilters() {
            if (materialsData.length === 0) return;

            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            // Get active category filters
            const activeCategories = [];
            if (document.getElementById('metal-filter').checked) activeCategories.push('Metal');
            if (document.getElementById('polymer-filter').checked) activeCategories.push('Polymer');
            if (document.getElementById('glass-filter').checked) activeCategories.push('Glass');
            if (document.getElementById('ceramic-filter').checked) activeCategories.push('Ceramic');

            // Filter materials
            filteredMaterials = materialsData.filter(material => {
                // Search term filter
                if (searchTerm && !material.Material.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Category filter - if no categories selected, show all
                if (activeCategories.length > 0 && !activeCategories.includes(material.Category)) {
                    return false;
                }

                // Metal-specific filters
                if (activeCategories.includes('Metal') && material.Category === 'Metal') {
                    const magnetismSelect = document.getElementById('magnetism-select').value;
                    if (magnetismSelect !== 'any' && material.Magnetism !== magnetismSelect) {
                        return false;
                    }
                    
                    const thermalSelect = document.getElementById('metal-thermal').value;
                    if (thermalSelect !== 'any' && material['Thermal Stability'] !== thermalSelect) {
                        return false;
                    }
                    
                    const meltingPointThreshold = parseFloat(document.getElementById('metal-melting-point').value);
                    if (material['Melting Point'] && parseFloat(material['Melting Point']) < meltingPointThreshold) {
                        return false;
                    }
                }

                // Polymer-specific filters
                if (activeCategories.includes('Polymer') && material.Category === 'Polymer') {
                    const polymerType = document.getElementById('polymer-type').value;
                    if (polymerType !== 'any' && material['Polymer Type'] !== polymerType) {
                        return false;
                    }
                    
                    const additives = document.getElementById('additives').value;
                    if (additives !== 'any' && material.Additives !== additives) {
                        return false;
                    }
                    
                    const toxicity = document.getElementById('polymer-toxicity').value;
                    if (toxicity !== 'any' && material.Toxicity !== toxicity) {
                        return false;
                    }
                    
                    const densityThreshold = parseFloat(document.getElementById('density').value);
                    if (material.Density && Math.abs(parseFloat(material.Density) - densityThreshold) > 0.5) {
                        return false;
                    }
                }

                // Glass-specific filters
                if (activeCategories.includes('Glass') && material.Category === 'Glass') {
                    const meltingPointThreshold = parseFloat(document.getElementById('glass-melting-point').value);
                    if (material['Melting Point'] && parseFloat(material['Melting Point']) < meltingPointThreshold) {
                        return false;
                    }
                    
                    const densityThreshold = parseFloat(document.getElementById('glass-density').value);
                    if (material.Density && Math.abs(parseFloat(material.Density) - densityThreshold) > 0.5) {
                        return false;
                    }
                    
                    const toxicity = document.getElementById('glass-toxicity').value;
                    if (toxicity !== 'any' && material.Toxicity !== toxicity) {
                        return false;
                    }
                }

                // Ceramic-specific filters
                if (activeCategories.includes('Ceramic') && material.Category === 'Ceramic') {
                    const meltingPointThreshold = parseFloat(document.getElementById('ceramic-melting-point').value);
                    if (material['Melting Point'] && parseFloat(material['Melting Point']) < meltingPointThreshold) {
                        return false;
                    }
                    
                    const thermalSelect = document.getElementById('ceramic-thermal').value;
                    if (thermalSelect !== 'any' && material['Thermal Stability'] !== thermalSelect) {
                        return false;
                    }
                    
                    const densityThreshold = parseFloat(document.getElementById('ceramic-density').value);
                    if (material.Density && Math.abs(parseFloat(material.Density) - densityThreshold) > 1.0) {
                        return false;
                    }
                }

                return true;
            });

            displayMaterials(filteredMaterials);
            updateResultsCount(filteredMaterials.length);
        }

        // Function to open material details page
        function openMaterialDetails(materialId, materialName) {
            const url = `material-details.html?id=${encodeURIComponent(materialId)}&name=${encodeURIComponent(materialName)}`;
            window.location.href = url;
        }
    </script>
</body>
</html>